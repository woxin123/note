# HTTP

## HTTP 概述

HTTP 是一种超文本传输协议，HTTP 的全称是 HyperText Transfer Portocal。它使用了 TCP 作为传输层。

## HTTP 特点

HTTP 是一个无状态的协议。

### HTTP 连接

HTTP 1.0 使用的是非持续连接。即每一个请求都会创建一个连接，然后当这个请求处理结束后断开连接，但是 HTTP 1.0 支持持续连接，也就是场链接。需要使用参数 `keep-alive` 告知服务器需要建立一个长连接。

HTTP 1.1 默认支持长连接。

### 持续连接（长连接）的两种工作方式

- 非流水线：客户在收到前一个响应后才能发出下一个请求。这比非持续连接的两倍 RTT 的开销节省了建立 TCP 连接所需的一个 RTT 时间。但服务器在发送完一个对象后，其 TCP 连接就处于空闲状态，浪费了服务器资源。
- 流水线方式：客户在收到 HTTP 的响应报文之前就能够接着发送新的请求报文。一个接一个的请求报文到达服务器后，服务器就可连续发回响应报文。使用流水线的方式，客户访问所有的对象只需花费一个 RTT 时间，使 TCP 连接的空闲时间减少。

### HTTP 报文结构

HTTP 的报文分两类：

- 请求报文——从客户想服务器发送请求报文。
- 响应报文——从服务器到客户的回答。

报文由三部分组成：

- 开始行
- 首部行
- 实体主体

请求报文结构：

开始行：方法 URL 版本 CRLF(回车换行)
首部字段名: 值 CRLF
...
...
...
首部字段名: 值 CRLF
CRLF (空行)
实体主体

这里的方法指的是 HTTP 的方法，用于区分请求的类型或者行为。

#### HTTP 的方法

HTTP 请求报文的一些方法：

|方法|意义|
|:---:|-----|
|GET|请求读取由 URL 所标识的信息|
|HEAD|请求读取由 URL 所标识的信息的首部|
|POST|给服务器添加信息|
|PUT|在指定的 URL 下存储一个文档|
|DELETE|删除指定的 URL 所标识的资源|
|TRACE|用来进行环回测试的请求报文|
|CONNECT|要求用隧道协议连接代理服务器|
|OPTION|请求一些选项的信息|

#### HTTP 的 URL

##### URI 和 URL 的区别

首先我们来说一下 URL 和 URI 的区别：

URI 的全称时 Uniform Resource Identifier，统一资源标识符。

URL 的全称时 Uniform Resource Location, 统一资源定位符。

URI 时统一资源标识符，能够用来唯一地标识互联网的每一个资源的都可以被称为 URI。它是一种抽象的概念。而 URL 是 URI 的一种，它通过一个路径唯一的区分互联网上的每一个资源。URL 就相当于现实生活中的地址。加入你要写信或者寄快递，那么你需要通过一个地址来说明你邮寄的目的地；反映在互联网上就是当前想要获取某一个资源的时候，你需要知道这个资源所对应的 URL。

##### URL 的语法格式

URL 提供了一种定位在因特网和任意资源的手段，但这些资源是可以通过各种不同的方案（比如 HTTP,FTP, SMTP）来访问的，因此 URL 语法会随着方案的不同而不同。

大部分 URL 方案都遵循如下的 9 大通用组件：

```
<scheme>://<user>:<password>@<host>:<port>/<path>;<params>?<query>#<frag>
```

URL 的语法中有最重要的三部分分别是：

1. 方案 scheme ，例如：HTTP, FTP, SSH 等。
2. 主机 host，主机可以直接的 IP 地址，或者是域名，例如：www.baidu.com，127.0.0.1 等。
3. 路径 path，也就是资源在所在主机上的本地名。

下表总结了 URL 的通用组件：

|组件|描述|默认值|
|:---:|----|:---:|
|方案|访问服务器以获取某种资源时使用的时那种协议|无|
|用户|某些方案访问时需要给出用户名，中间由冒号（:）分隔|匿名|
|密码|某些用户名后面可能需要跟随密码，中间由冒号（:）分隔|\<E-mail\>地址|
|主机|资源宿主服务器的主机名或者分点IP地址（由 "." 分隔的 IP 地址）|无|
|端口|资源宿主服务器正在监听的端口号，很多方案都有默认的端口号（HTTP 默认的端口号为 80）|每个方案特有|
|路径|服务器资源的本地名，由一个斜杠(/)将其与前面的 URL 组件分隔开。路径组件的语法是与服务器和方案有关的|无|
|参数|某些方案可能会用这个组件来指定输入参数。参数为 key/value 对。URK中可以包含多个参数字段，它们相互之间以及与路径的其与部分用分号(;)分隔|无|
|查询|某些方案会用这个组件传递参数以激活相应的。查询的组件内容没有通用的格式。用字符 "?" 将其与 URL 的其余部分分隔开。|无|
|片段|一小段或者一部分资源的名称。引用对象时，不会将 frag 字段传送给服务器，这个字段通常是在客户端内部使用的。通过 "#" 将其与 URL 的其与部分分隔开来|无|

for example:

http://www.baidu.com，协议：http ，主机名：www.baidu.com，端口：http 默认端口 80，路径：无。

下来来细说一下查询，查询字符串其实是没有任何要求的，只是通常的 http 请求都将查询组件通过 key/value 的形式，以 & 符号分隔的形式来组织。但是其实在 URL 中查询组件是没有任何要求的。

##### URL 的字符集以及 URL 编码

URL 的编码使用了 能够打印的 ASCII 编码。那么加入出现了不可打印的字符或者中文怎么办呢? 答案就是需要通过一种编码将这种不可见的或者非 ASCII 编码转换成 ASCII 编码，就是所谓的 URL 编码。

URL 编码通过一个 "%" 后面跟着两个表示字符的 ASCII 编码的十六进制数。

下表列出了一些字符的编码：

|字符|ASCII码|编码|
|:---:|:----:|:----:|
|~|126(0x7E)|%7E|
|空格|32(0x20)|%20|
|%|37(0x25)|%25|

在 URL 中。有几个字符被保留起来，有着特殊的含义。这些字符不在指定的 ASCII 可打印字符中，还有一些字符会和协议产生混淆。

下面是 URL 中的需要转码的特殊字符：

|字符|保留/受限|
|:--:|:---:|
|%|保留用作编码字符的转义标志|
|/|保留作为路径组件中分隔路径的定界符|
|.|保留在路径组件之中|
|..|保留在路径组件之中|
|#|保留作为分段定字符使用|
|?|保留作为查询字符串定界符使用|
|;|保留作为参数定界符使用|
|:|保留作为方案，用户/口令，以及主机/端口组件的定界符使用|
|$,+|保留|
|@ & =|在某些方案中由特殊的含义，保留|
|{}\|\\^~[]'|用于各种传输 Agent 代理，比如各种网关的不安全处理，使用受限|
|<>"|不安全，使用可能会出现混乱，影响解析（例如 "http://www.baidu.com"，假如其中出现 `"`，可能会解析出错）|
|0x00~0x1F, 0x7F|受限，不可打印|
|>0x7F|受限，不在 ASCII 定义的 7 比特范围内|


#### HTTP 的版本

HTTP 的版本有 HTTP 1.0, HTTP 1.1, 和 HTTP 2.0。

-----------------

HTTP 的报文结构示例：

![HTTP 报文结构示例](http://img.mcwebsite.top/blog/img/20190820135829.png)

请求报文和响应报文的区别就在于开始行不同。

响应报文：

```text
版本 状态吗 短语 CRLF
首部字段名: 值 CRLF
...
...
...
首部字段名: 值 CRLF
CLRF
实体主体（有些响应报文不用）
```

响应报文的开始行是**状态行** 。

状态行包括三项内容，即 **HTTP 的版本，状态码，** 以及解析状态码的**简单短语**。

#### HTTP 状态码

HTTP 状态码分为如下 5 大类：

1. 1xx 表示通知信息的，如请求收到了或正在进行处理。

2. 2xx 表示成功，如接收或知道了。

3. 3xx 表示重定向，表示要完成请求必须采取进一步的行动。

4. 4xx 表示客户端的请求出错。

5. 5xx 表示服务器处理时发生内部错误。可能是来源于服务器自身的问题，而不是请求者操作失误造成的。

##### 1xx

|状态码|状态码英文名称|含义|
|:---:|:----|--------|
|100|Continue|继续，客户端应继续其请求。|
|101|Switching Protocols|切换协议。服务器根据客户端的请求切换协议。只能切换到更高级的协议，例如，切换到 HTTP 的新版协议|

##### 2xx

|状态码|状态码英文名称|含义|
|:---:|:----|--------|
|200|OK|请求成功。一般用于 GET 与 POST 请求|
|201|Created|已创建，成功请求并创建了资源|
|202|Acceptd|已接收|已经接收请求，但未处理完成|
|203|Non-Auhoritative|非授权信息。请求成功，但返回的 meta 信息不在原始的服务器，而是一个副本|
|204|No Content|无内容，服务器成功处理，但未返回内容。在未更新网页的情况下，可确保浏览器继续显示当前文档|
|205|Reset Content|重置内容。服务器处理成功，用户终端应重置文档视图。可通过此返回码清除浏览器的表单域|
|206|Partial Content|部分内容，服务器成功处理了部分 GET 请求|

##### 3xx

|状态码|状态码英文名称|含义|
|:---:|:----|--------|
|300|Multiple Choices|多种选择。请求的资源可包括多个位置，响应可返回一个资源的特征与地址的列表用于终端选择|
|301|Moved Permanently|永久重定向。请求的资源已被**永久**的移动到新的URI，浏览器会自动定向到新的 URL。今后任何新的请求都应使用新的 URI 代替|
|302|Found|临时移动。与 301 类似。但资源只是临时被移动。客户端应继续使用原有的 URI|
|303|See Other|查看其他地址。与 301 类似。使用 GET 和 POST 请求查看|
|304|Not Modified|未修改。锁请求的资源未修改，服务器返回此状态码时，不会返回任何资源。客户端通常会缓存访问过的资源，通过提供一个头信息指出客户端希望值返回在指定日期之后修改的资源。|
|305|Use Proxy|使用代理，所有的请求必须通过代理访问|
|306|Temporary Redirect|临时重定向。使用 GET 请求重定向|

这里比较重要的是 301 和 302 以及 304。

##### 4xx

|状态码|状态码英文名称|含义|
|:---:|:----|--------|
|400|Bad Request|客户端请求的语法错误，服务器无法理解|
|401|Unauthorized|请求要求用户的身份认证|
|402|Payment Required|保留，将来使用|
|403|Forbidden|服务器理解请求客户端的请求，但是拒绝执行此请求|
|404|Not Found|服务器无法根据客户端的请求找到资源（网页）。通过代码，网站设计任意可设置一些漂亮的 404 页面|
|405|Method Not Allowed|客户端中的方法被禁止|
|406|Not Acceptable|服务器无法根据客户端请求的内容特性完成请求|
|407|Proxy Authentication Required|请求要求代理的身份认证，与 401 类似，但请求应当使用代理进行授权|
|408|Request Time-out|服务器等待客户端发送的请求时间过长，超时|
|409|Conflict|服务器完成客户端的 PUT 请求时可能返回此代码，服务器处理请求发生冲突|

##### 5xx

|状态码|状态码英文名称|含义|
|:---:|:----|--------|
|500|Internal Server Error|服务器内部错误，无法完成请求|
|501|Not Implemented|服务器不支持请求的功能，无法完成请求|
|502|Bad Gateway|作为网关或者代理工作的服务器尝试执行请求时，从服务器接收到了一个无效的响应。
|503|Service Unavailable|由于超载或系统维护，服务器暂时无法处理客户端的请求。延时的长度包含在服务器的 Retry-After 头信息中|
|504|Gateway Time-out|充当网关或代理服务器，未及时从远端服务器获取请求|
|505|HTTP Version not supported|服务器不支持请求的 HTTP 协议的版本，无法完成处理|

