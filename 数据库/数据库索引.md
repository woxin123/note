
# 数据库索引

索引是对数据库表的中一个或多个列的值进行排序的数据结构，用来协助快速查询，更新数据库表中的数据。

索引的实现通常使用B树和B+树。

索引加快了数据访问，因为存储引擎不会去再描述整张表得到需要的数据；相反，它从根节点开始，根节点保存了节点的指针，存储引擎会根据指针快速寻找数据。

![](http://static.zybuluo.com/Rico123/z13w648etta3tb90di3btu5b/%E7%B4%A2%E5%BC%95.png?ynotemdtimestamp=1543550627371)

+ 上图显示了一种索引方式。左边是数据库中的数据表，有col1和col2两个字段，一共有15条记录；
+ 右边与以col2列为索引列的B-TREE索引，每个节点包含索引的键值和对应数据库表地址的指针，这样就开而已通过B-TREE在O(logN)的时间复杂度内获取相应的数据，这样明显加快了检索的速度。

## 索引底层的实现

### MyISAM索引的实现

MyISAM引擎使用B+树作为索引结构，叶子节点的data域存放的是数据记录的地址。

![](http://img-blog.csdn.net/20160926141231996?ynotemdtimestamp=1543550627371)

+ 假设Col1为主键，则上图是一个MyISAM表的主索引；
+ MyISAM的索引文件仅仅保存数据记录的地址；
+ 在MyISAM中，主索引和辅助索引（Second key）在结构上没有任何的区别，只是主索引要求的key是唯一的，而辅助索引的key是可以重复的。

![](http://img-blog.csdn.net/20160926141811354?ynotemdtimestamp=1543550627371)

+ 同样也是B+树，data域保存的数据的地址。因此，MyISAM中索引检索的算法为首先按照B+树搜索算法搜索索引，如果指定的key存在，则取出其data域的值为地址，读取相应记录。
+ MyISAM的索引方法也叫作“非聚集”。

### InnoDB索引实现

虽然InnoDB也是使用B+树作为索引的结构，当具体的实现方式却与MyISAM截然不同。

第一个区别是InnoDB的数据文件本身就是索引。

MyISAM索引文件和数据是分离的，索引文件仅仅保存数据记录的地址。

而在InnoDB中，表数据文件本身就是B+树组织的一个索引结构，这棵树的叶子节点data域保存了完整的记录。这个索引的key就是数据表的主键，因此InnoDB表数据文件本身就是索引。

![](http://img-blog.csdn.net/20160926141856136?ynotemdtimestamp=1543550627371)

+ 上图是InnoDB主索引（同时也是数据文件）的示意图，可以看到叶子节点包含了完整的数据记录。
+ 这种索引叫做聚集索引，因为InnoDB的数据文件本身要按主键聚集，所以InnoDB要求表必须有主键（MyISAM可以没有），如果没有显示的指定，则MySQL会自动的选择一个唯一标识的列作为主键。
+ 如果不存在这种列，则MySQL宗东伟InnoDB自动生成一个隐含字段作为主键，这个字段长为6个字节，类型为长整型。

第二个与MyISAM索引不同的是InnoDB的辅助索引data与存储相应记录的值而不是地址。也就是说，InnoDB的索引辅助索引都引用主键作为data域。

+ 聚集索引这种实现方式使得主键的搜索十分的高效，但是辅助索引需要检索两次索引：首先检索辅助索引获得主键，然后用主键到主索引中检索获得记录。

## 索引的优点

+ 大大加快数据的检索速度，这也是创建索引的最主要原因；
+ 加速表和表之间的连接。
+ 在使用分组和排序进行数据检索时，通常可以显著减少分组和排序的时间；
+ 通过创建唯一性索引，可以保证数据库表中的每一行数据的唯一性。

### 索引的缺点

+ 时间方面：创建和维护索引需要耗费时间，具体的，当对表中的数据进行增加，删除和修改的时候，索引也需要动态维护，这样就降低了插入删除的速度
+ 空间方面：索引需要占用物理空间。

### 索引的分类

+ 普通索引和唯一索引：索引的值的唯一性。
+ 单个索引和联合索引：索引所包含的列数。
+ 聚簇索引和非聚簇索引：聚簇索引按照数据的物理存储进行划分的，对于一堆记录来说，使用非聚簇索引就是对这堆记录进行堆划分。即主要描述的是物理上的存储，迅速减小范围。但是查找该记录，就要从这个小的范围寻找了；非聚簇索引是把一个很大范围，转换成一个小的地图，然后你需要在个小的地图，然后你需要在这个小地图中找你所寻找的信息的位置，通过这个位置去寻找记录。

### 什么情况下设置了索引但是无法使用？

+ 以“%”（表示任意0个或者多个字符）开头的LIKE语句，模糊匹配；
+ OR语句前后没有同时使用索引
+ 数据类型出现隐式转换（比如varchar不加单引号的话可能会自动转换为int类型）
+ 对于多列索引，必须满足最左匹配。

### 联合索引的最左前缀原理

联合索引（复合索引）

相对于一般索引只有一个字段，联合索引可以为多个字段创建一个索引，则索引记录会按照A字段排序，比如在(a, b, c)字段上建立一个联合索引，则索引记录会按照A字段排序，然后在按照B字段排序然后再是C字段，因此联合索引的特点就是：

+ 第一个字段一点是有序的。
+ 当第一个字段值相等的时候，第二个字段又是有序的，比如下表中当A=2时，所有B的值是有序排列的，比如下表中的当A=2时所有B的值是有序排列的，以此类推，当同一个B的值的所有C字段是有序排列的
+ 联合索引的查找就像字典一样，先根据第一个字母查，然后在根据第二个字母查，或者只根据第一个字母查询，但是不能跳过第一个字母根据第二个字母查。这就是最左前缀的原理。

### 前缀索引

除了联合索引外，对mysql来说其实还有一种前缀索引。前缀索引就是用列的前缀代替整个列作为索引的key，当前缀长度合适时，可以做到即使前缀索引的选择性接近全列索引，同时因为索引的key变短而减少了索引文件的大小和开销维护。

一般来说下列情况适合使用前缀索引：

+ 字符串（varchar,char,text等），需要进行全字段匹配或者前匹配。也就是='xxx'或者like = 'xxx%'
+ 字符串本身比较长，而且前几个字符就开始不相同，比如对中国人的姓名使用前缀索引就没有意义，因为中国人名字短，而且对性重复多，电子邮件是一个可以使用前缀所有的字段。
+ 前一半字符的索引选择性就已经接近于全字段的索引选择性。如果整个字段的长度为20，索引选择性为0.9，而我们对于前10个字符建立索引其选择性也只有0.5，那么就加大前缀字符的长度，但这时前缀索引优势也不太明显。

MySQL前缀索引能有效减小索引文件的大小，提高索引的速度。但是前缀索引也有缺点：

+ MySQL不能在ORDER BY或GROUP BY中使用前缀索引，也不能把它们用作覆盖索引。


### 索引优化策略

+ 最左匹配原则
+ 主键外键一定要建立索引
+ 对where，on，group by，order by中出现的列使用索引
+ 选择区分度高的列做索引，也就是表示字段不重复的比例，比例越大扫描记录越少，唯一键的区分度为1，而一些状态，性别字段可能在大数据前区分度为0
+ 对较小的数据列使用索引，这样会使索引文件更小，同时内存中也可以装载更多索引键
+ 为比较长的字符串使用前缀索引。
+ 不要过多的创建索引，权衡索引个数与DML之间的关系。DML也就是插入删除操作。建立的索引过多，会影响插入，删除数据的速度，因为修改表的数据时，索引也需要调整，
+ 对于like查询，“%”不要放在前面。

```sql
SELECT * FROMhoudunwangWHEREunameLIKE'后盾%' -- 走索引 
SELECT * FROMhoudunwangWHEREunameLIKE "%后盾%" -- 不走索引
```

+ 查询where条件数据类型不匹配也无法使用索引

```sql
CREATE TABLEa(achar(10)); 
EXPLAIN SELECT * FROM a WHERE a = "1" – 走索引 
EXPLAIN SELECT * FROM a WHERE a = 1 – 不走索引 
```

### 主键，自增主键，主键索引和唯一索引的区别

主键：指字段唯一，不为空值的列。

主键索引：指的就是主键，主键是索引的一种，是唯一索引的特殊类型。创建主键的时候，数据库会默认创建一个唯一索引。

自增主键：字段类型为数字，自增，并且是主键。

唯一索引：索引列的值必须是唯一，但允许有空值。主键是唯一索引，但是反过来说唯一索引也是主键就错了，因为唯一索引允许空值，主键不允许有空值。

### 主键就是聚簇索引吗？主键和索引有什么区别？

主键是一种特殊的唯一索引，其可以聚簇索引，也可以是非聚簇索引。

使用InnoDB作为MySQL存储引擎时，默认按照主键进行聚集，如果没有定义主键，InnoDB会试着使用唯一的非空索引代替。如果没有这种索引，InnoDB机会定义隐藏的主键然后在上面进行聚集。所以，对于聚集索引来说，创建主键的时候，自动就创建了主键的聚集索引。 

### 覆盖索引

覆盖索引（convering index)指一个查询语句的执行只用从索引中就能取得，不必从数据表中读取。也可以称之为索引覆盖。

如果一个索引包含了（或覆盖了）满足查询语句中字段与条件的数据就叫做覆盖索引。